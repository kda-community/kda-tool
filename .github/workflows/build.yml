
name: Build

on:
  workflow_dispatch:

  push:
    paths:
    - '**'
    - '!.github/**'
    - '.github/workflows/applications.yml'

jobs:
  build:
    if: "!startsWith(github.ref, 'refs/tags/')"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        ghc: ["9.10.3"]
        cabal: ["3.12"]
        os: ["ubuntu-22.04", "ubuntu-24.04", "macos-14", "macos-15"]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
          ref: ${{ inputs.commit_sha || github.sha }}

    - name: Extract version from cabal file
      run: |
        VERSION=$(grep -E '^version:' kda-tool.cabal | awk '{print $2}')
        echo "VERSION=$VERSION" >> $GITHUB_ENV


    # Haskell Setup
    - name: Set permissions for .ghcup (ubuntu)
      if: startsWith(matrix.os, 'ubuntu-')
      run: sudo chown -R $USER /usr/local/.ghcup
    - name: Install GHC and Cabal
      uses: haskell-actions/setup@v2
      with:
         ghc-version: ${{ matrix.ghc }}
         cabal-version: ${{ matrix.cabal }}
    - name: Confirm GHC and Cabal installation
      run: |
        ghc --version
        cabal --version

    - name: Setting up MPFR (Ubuntu)
      if: startsWith(matrix.os, 'ubuntu-')
      shell: bash
      run: sudo apt-get update && sudo apt-get install -y libmpfr-dev

    # Project Setup
    - name: Create cabal.project.local
      shell: bash
      run: |
        cat > cabal.project.local <<EOF
        documentation: False
        package pact
          tests: True
          benchmarks: True
          documentation: False
          optimization: 1
          flags: ${{ matrix.flags }} +cryptonite-ed25519
        extra-include-dirs:
          /opt/local/include
          /usr/local/opt/openssl/include
        extra-lib-dirs:
          /opt/local/lib
          /usr/local/opt/openssl/lib/
        EOF

    - name: Extend cabal.project.local for GHC-9.0.2
      if: "startsWith(matrix.ghc, '9')"
      shell: bash
      run: |
        cat >> cabal.project.local <<EOF
        package pact
          ghc-options: -Wwarn -Wunused-packages
        EOF

    - name: Add check for unused packages
      shell: bash
      run: |
        cat >> cabal.project.local <<EOF
        package pact
          ghc-options: -Wunused-packages
        EOF

    - name: Print cabal.project.local
      shell: bash
      run: cat cabal.project.local

    - name: Update package database
      shell: bash
      run: cabal update

    - name: Configure build / and freeze
      run: |
        cabal build --dry-run
        cabal freeze

    - name: Generate cache key
      id: cache-key
      run: |
        grep -v '^index-state:' cabal.project.freeze > freeze-deps-only
        FREEZE_HASH=$(shasum freeze-deps-only | cut -d' ' -f1)
        echo "freeze-hash=$FREEZE_HASH" >> $GITHUB_OUTPUT
        rm freeze-deps-only

    - name: Restore Cabal store
      id: restore-cabal
      uses: actions/cache/restore@v5
      with:
        path: ~/.cabal/store
        key: cabal-${{ matrix.os }}-${{ matrix.ghc }}-${{ steps.cache-key.outputs.freeze-hash }}
        restore-keys: |
          cabal-${{ matrix.os }}-${{ matrix.ghc }}

    - name: Build dependencies
      if: steps.restore-cabal.outputs.cache-hit != 'true'
      shell: bash
      run: cabal build --only-dependencies

    - name: Cache Cabal store if necessary
      if: steps.restore-cabal.outputs.cache-hit != 'true'
      uses: actions/cache/save@v5
      with:
        path: ~/.cabal/store
        key: cabal-${{ matrix.os }}-${{ matrix.ghc }}-${{ steps.cache-key.outputs.freeze-hash }}

    - name: Build
      shell: bash
      run: cabal build

    - name: Verify Binary Linking
      shell: bash
      run: cabal run exe:kda -- --help

    - name: Extract version and set up variables
      shell: bash
      run: |
        VERSION=$(cabal run exe:kda -- --version)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "ARCHIVE_DIR=kda-tool-$VERSION" >> $GITHUB_ENV
        echo "ARCHIVE_NAME=kda-tool-$VERSION-${{matrix.os}}" >> $GITHUB_ENV

    - name: Prepare release artifact
      shell: bash
      run: |
        OUTPUT_DIR=artifacts/$ARCHIVE_DIR
        mkdir -p $OUTPUT_DIR
        cp $(cabal list-bin kda) $OUTPUT_DIR
        cp CHANGELOG.md $OUTPUT_DIR
        cp README.md $OUTPUT_DIR
        cp LICENSE $OUTPUT_DIR

    - name: Strip binary
      shell: bash
      run: strip artifacts/$ARCHIVE_DIR/kda

    - name: Build release archive
      shell: bash
      run: |
        cd artifacts
        tar czf $ARCHIVE_NAME.tar.gz $ARCHIVE_DIR

    - name: Upload artifact
      uses: actions/upload-artifact@v6
      with:
        name: release-arch-${{matrix.os}}
        retention-days: 1
        path: artifacts/*.tar.gz

  merge:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download All artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts
          pattern: release-arch-*
          merge-multiple: true

      - name: Compute Cheksums
        shell: bash
        run: |
          cd artifacts
          sha256sum * > SHA256SUMS

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: releases
          retention-days: 30
          path: artifacts/*.tar.gz